<stack:stack>

<stack:copyright>
Copyright (c) 2006 - 2019 Teradata
All rights reserved. Stacki(r) v5.x stacki.com
https://github.com/Teradata/stacki/blob/master/LICENSE.txt
</stack:copyright>


<stack:script stack:cond="release == 'redhat7'" stack:stage="install-pre">
<!-- Load SCSI Generic Module. Required for HPSSACLI,
     and StorCLI, on RHEL/CentOS 7.x -->
modprobe sg
</stack:script>

<stack:script stack:stage="install-pre">
mkdir -p /tmp/stack_site/
cat /run/install/tmp/ks.xml | \
	/opt/stack/bin/stack list host profile chapter=stacki \
	2> /tmp/profile_stack_site.debug \
	> /tmp/stack_site/__init__.py
</stack:script>

<stack:script stack:stage="install-pre">
# util func to pause the install, alert the console user, alert the MQ
function halt_install {
    console_err_msg=$1
    mq_health_msg=$2

    echo $console_err_msg > /tmp/wait
    echo $console_err_msg
    while [ -f /tmp/wait ]
    do
        sleep 1
        /opt/stack/bin/smq-publish -chealth $mq_health_msg
    done
}

# nuke the disks, if appropriate
/opt/stack/bin/initialize-storage.py
if [ $? -ne 0 ]
then
    halt_install "Unable to initialize internal storage configuration." \
        '{"state": "nukedisk failed - check console or reinstall with halt_install_on_error=False"}'
fi

#
# configure the hardware disk array controller first
#
/opt/stack/bin/configure-controllers.py
if [ $? -ne 0 ]
then
    halt_install "Unable to complete storage controller configuration." \
        '{"state": "controller config failed - check console or reinstall with halt_install_on_error=False"}'
fi

#
# need to call 'initialize-storage.py' again after reconfiguring the
# hardware disk controller because it may have created new LUNs and the
# master boot record on a LUN may be corrupted and require initialization.
#
/opt/stack/bin/initialize-storage.py
if [ $? -ne 0 ]
then
    halt_install "Unable to initialize internal storage configuration after storage controller config." \
        '{"state": "post-controller config initialization failed - check console or reinstall with halt_install_on_error=False"}'
fi

# then configure the partitions
/opt/stack/bin/configure-partitions.py > /tmp/partition-info
if [ $? -eq 1 ]
then
    halt_install "Unable to find disks to create partitioning scheme on." \
        '{"state": "partition config failed - no disks found"}'
fi

</stack:script>


<stack:package>stack-storage-config</stack:package>


<stack:script stack:chroot="false" stack:stage="install-post">
mkdir -p /mnt/sysimage/tmp/stack_site
cp /tmp/stack_site/__init__.py /mnt/sysimage/tmp/stack_site/
</stack:script>

<stack:script stack:stage="install-post">
/opt/stack/bin/record-partitions.py

</stack:script>


<stack:script stack:cond="release == 'redhat7'" stack:stage="install-post">

<stack:file stack:name="/etc/modules-load.d/sg.conf">
# Bug in CentOS / RHEL 7.0. SCSI Generic Module
# is not loaded by default
sg
</stack:file>

</stack:script>


</stack:stack>

